<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.3.9: http://docutils.sourceforge.net/" />
<title>Resource Arbitration</title>
<meta name="author" content="David Gay" />
<meta name="author" content="David Culler" />
<meta name="author" content="Philip Levis" />
<meta name="author" content="Kevin Klues" />
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:date: $Date: 2005-10-31 22:16:36 $
:version: $Revision: 1.1.2.1 $
:copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.
*/
body {
  font-family: Times;
  font-size: 16px;
}

.first {
  margin-top: 0 ! important }

.last {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dd {
  margin-bottom: 0.5em }

/* Uncomment (& remove this text!) to get bold-faced definition list terms
dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.attention, div.caution, div.danger, div.error, div.hint,
div.important, div.note, div.tip, div.warning, div.admonition {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

div.hint p.admonition-title, div.important p.admonition-title,
div.note p.admonition-title, div.tip p.admonition-title,
div.admonition p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em }

div.footer, div.header {
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 0em 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1 {
  font-family: Arial, sans-serif;
  font-size: 20px;
}

h1.title {
 text-align: center;
 font-size: 32px;
}

h2 {
 font-size: 16px;
 font-family: Arial, sans-serif;
}

h2.subtitle {
  text-align: center }

h3 {
 font-size: 12px;
 font-family: Arial, sans-serif;
}

hr {
  width: 75% }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.line-block {
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.option-argument {
  font-style: italic }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

table {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.citation {
  border-left: solid thin gray ;
  padding-left: 0.5ex }

table.docinfo {
  margin: 2em 4em;
}

table.footnote {
  border-left: solid thin black ;
  padding-left: 0.5ex }

td, th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

th.docinfo-name, th.field-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap;
  }

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
  font-size: 100% }

tt {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="resource-arbitration">
<h1 class="title">Resource Arbitration</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr class="field"><th class="docinfo-name">TEP:</th><td class="field-body">108</td>
</tr>
<tr class="field"><th class="docinfo-name">Group:</th><td class="field-body">Core Working Group</td>
</tr>
<tr class="field"><th class="docinfo-name">Type:</th><td class="field-body">Documentary</td>
</tr>
<tr><th class="docinfo-name">Status:</th>
<td>Draft</td></tr>
<tr class="field"><th class="docinfo-name">TinyOS-Version:</th><td class="field-body">2.x</td>
</tr>
<tr><th class="docinfo-name">Author:</th>
<td>David Gay</td></tr>
<tr><th class="docinfo-name">Author:</th>
<td>David Culler</td></tr>
<tr><th class="docinfo-name">Author:</th>
<td>Philip Levis</td></tr>
<tr><th class="docinfo-name">Author:</th>
<td>Kevin Klues</td></tr>
<tr class="field"><th class="docinfo-name">Draft-Created:</th><td class="field-body">28-Mar-2005</td>
</tr>
<tr class="field"><th class="docinfo-name">Draft-Version:</th><td class="field-body">1.6</td>
</tr>
<tr class="field"><th class="docinfo-name">Draft-Modified:</th><td class="field-body">2005-07-06</td>
</tr>
<tr class="field"><th class="docinfo-name">Draft-Discuss:</th><td class="field-body">TinyOS Developer List &lt;tinyos-devel at mail.millennium.berkeley.edu&gt;</td>
</tr>
</tbody>
</table>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This memo documents a part of TinyOS for the TinyOS Community, and
requests discussion and suggestions for improvements.  Distribution
of this memo is unlimited. This memo is in full compliance with
TEP 1.</p>
</div>
<div class="section" id="abstract">
<h1><a name="abstract">Abstract</a></h1>
<p>This memo documents the general resource sharing mechanisms for TinyOS
2.x. These mechanisms are used to allow multiple software components to
arbitrate the use of both hardware buses, software components, etc.</p>
</div>
<div class="section" id="introduction">
<h1><a name="introduction">1. Introduction</a></h1>
<p>Components that wish to use a shared resource, such as a hardware bus,
memory or the services offered by another component need a way to arbitrate
use of these resources.</p>
<p>In TinyOS 1.x, this arbitration was performed on a first-come, first-served
basis by having requests for, e.g., a service X return FAIL if it was
currently in use. Users of X could monitor service completion events if
they wished to retry a failed request. This approach has several drawbacks:</p>
<ul class="simple">
<li>If you need to make several requests of X, you have to handle the
possibility of failure at any stage. This complicates implementations by
adding extra internal states.</li>
<li>You have no control over timing of a sequence of operations. This is a
problem for, e.g., timing-sensitive use of an A/D converter.</li>
<li>If a hardware resource supports reservation, you cannot express this
via this software interface. For instance, I2C buses have a concept of
&quot;repeated start&quot; when doing multiple bus transactions, but it was not
clear how to use this in TinyOS 1.x's I2C abstraction.</li>
<li>Most TinyOS 1.x services did not provide a very convenient way of 
monitoring X's availability for the purpose of retries, nor very
clear documentation of which requests could happen simultaneously.</li>
</ul>
<p>In light of all these problems, TinyOS 2.x introduces resource reservation
mechanisms for use by components providing access to shared resources.</p>
</div>
<div class="section" id="resource-sharing-in-tinyos-2-x">
<h1><a name="resource-sharing-in-tinyos-2-x">2. Resource sharing in TinyOS 2.x</a></h1>
<p>A single approach to resource sharing is not appropriate for all
circumstances. For instance, requiring resource reservation allows programs
to have better timing guarantees for access to an A/D converter. But if
a program does not need precise timing guarantees (e.g., when measuring
temperature in a biological monitoring application), this extra resource
reservation step complicates code.</p>
<p>Thus, TinyOS services should offer resource sharing mechanisms appropriate
to their goals and level of abstraction. However, to preserve simplicity
and consistency there should only be a few different resource sharing
approaches, which we outline here.</p>
<ul class="simple">
<li>Resource reservation: the service must be reserved before use, via the
Resource interface. This approach is described in Section 3.  Because many
services will have similar approaches to resource sharing (e.g.,
round-robin, or priority-based), TinyOS includes default arbiters
implementing various resource sharing policies. These arbiters are
described in Section 4.</li>
<li>Request queuing: requests from different clients are queued and handled
in some (service-dependent) order. This approach is described in Section 5.</li>
<li>Resource virtualisation: the service is virtualised so as to support an
arbitrary number of clients - a typical example is the Timer service. From 
a programming perspective, this behaves similarly to resource queuing and
is therefore also described in Section 5.</li>
</ul>
<p>Note that request queuing and resource virtualisation may need to store
significant amounts of per-client state. We expect that lower-level
services will use the resource reservation approach, while higher level
ones will prefer queuing or virtualisation. These higher-level services
will typically be built on top of the lower-level, resource-reservation
based services.</p>
</div>
<div class="section" id="resource-reservation-interface">
<h1><a name="resource-reservation-interface">3. Resource Reservation Interface</a></h1>
<p>The resource interface is defined as follows:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">interface</span> <span class="pre">Resource</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">Request</span> <span class="pre">access</span> <span class="pre">to</span> <span class="pre">a</span> <span class="pre">shared</span> <span class="pre">resource.</span> <span class="pre">You</span> <span class="pre">must</span> <span class="pre">call</span> <span class="pre">release()</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">when</span> <span class="pre">you</span> <span class="pre">are</span> <span class="pre">done</span> <span class="pre">with</span> <span class="pre">it.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">&#64;return</span> <span class="pre">SUCCESS</span> <span class="pre">Request</span> <span class="pre">accepted.</span> <span class="pre">The</span> <span class="pre">granted()</span> <span class="pre">event</span> <span class="pre">will</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">be</span> <span class="pre">signaled</span> <span class="pre">when</span> <span class="pre">you</span> <span class="pre">have</span> <span class="pre">the</span> <span class="pre">resource.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">EBUSY</span> <span class="pre">You</span> <span class="pre">have</span> <span class="pre">already</span> <span class="pre">requested</span> <span class="pre">this</span> <span class="pre">resource</span> <span class="pre">via</span> <span class="pre">this</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">interface.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">async</span> <span class="pre">command</span> <span class="pre">error_t</span> <span class="pre">request();</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">Request</span> <span class="pre">immediate</span> <span class="pre">access</span> <span class="pre">to</span> <span class="pre">a</span> <span class="pre">shared</span> <span class="pre">resource.</span> <span class="pre">You</span> <span class="pre">must</span> <span class="pre">call</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">release()</span> <span class="pre">when</span> <span class="pre">you</span> <span class="pre">are</span> <span class="pre">done</span> <span class="pre">with</span> <span class="pre">it.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">&#64;return</span> <span class="pre">SUCCESS</span> <span class="pre">You</span> <span class="pre">now</span> <span class="pre">have</span> <span class="pre">the</span> <span class="pre">resource.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">EBUSY</span> <span class="pre">The</span> <span class="pre">resource</span> <span class="pre">is</span> <span class="pre">busy.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">async</span> <span class="pre">command</span> <span class="pre">error_t</span> <span class="pre">immediateRequest();</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">You</span> <span class="pre">have</span> <span class="pre">received</span> <span class="pre">access</span> <span class="pre">to</span> <span class="pre">this</span> <span class="pre">resource.</span> <span class="pre">Note</span> <span class="pre">that</span> <span class="pre">this</span> <span class="pre">event</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">is</span> <span class="pre">NOT</span> <span class="pre">signaled</span> <span class="pre">when</span> <span class="pre">immediateRequest()</span> <span class="pre">succeeds.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">event</span> <span class="pre">void</span> <span class="pre">granted();</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">Release</span> <span class="pre">a</span> <span class="pre">shared</span> <span class="pre">resource</span> <span class="pre">you</span> <span class="pre">previously</span> <span class="pre">acquired.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">async</span> <span class="pre">command</span> <span class="pre">void</span> <span class="pre">release();</span></tt></div>
<div class="line"><br /></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">Some</span> <span class="pre">other</span> <span class="pre">component</span> <span class="pre">has</span> <span class="pre">requested</span> <span class="pre">this</span> <span class="pre">resource.</span> <span class="pre">You</span> <span class="pre">might</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">want</span> <span class="pre">to</span> <span class="pre">consider</span> <span class="pre">releasing</span> <span class="pre">it.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">event</span> <span class="pre">void</span> <span class="pre">requested();</span></tt></div>
</div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span></tt></div>
</div>
<p>This Resource interface is offered as a parameterised interface by services
which wish to provide access to a shared resource. The interface's
parameter represents client ids. A component SomeNameC must #define
SOME_NAME_RESOURCE to a string which can be passed to the special unique()
function to obtain a client id. For instance, the I2C service might look
like this:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">includes</span> <span class="pre">I2CPacketC;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">configuration</span> <span class="pre">I2CPacketC</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">For</span> <span class="pre">reserving</span> <span class="pre">the</span> <span class="pre">I2C</span> <span class="pre">bus.</span> <span class="pre">'id'</span> <span class="pre">is</span> <span class="pre">the</span> <span class="pre">client</span> <span class="pre">id,</span> <span class="pre">obtained</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">via</span> <span class="pre">unique(I2C_RESOURCE)</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">interface</span> <span class="pre">Resource[uint8_t</span> <span class="pre">id];</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">Actual</span> <span class="pre">I2C</span> <span class="pre">packet</span> <span class="pre">interface.</span> <span class="pre">'busId'</span> <span class="pre">is</span> <span class="pre">the</span> <span class="pre">I2C</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">bus</span> <span class="pre">identifer</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">device</span> <span class="pre">you</span> <span class="pre">wish</span> <span class="pre">to</span> <span class="pre">use.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">interface</span> <span class="pre">I2CPacket[uint8_t</span> <span class="pre">busId];</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span> <span class="pre">...</span></tt></div>
</div>
<p>where I2CPacketC.h contains the #define for the resource:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">#ifndef</span> <span class="pre">I2CPACKETC_H</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">#define</span> <span class="pre">I2CPACKETC_H</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">#define</span> <span class="pre">I2CPACKET_RESOURCE</span> <span class="pre">&quot;I2CPacket.Resource&quot;</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">#endif</span></tt></div>
</div>
<p>The #define for the unique string must be placed in a separate file
because of the way nesC files are preprocessed: referring to I2CPacketC
isn't enough to ensure that macros #define'd in I2CPacketC are visible
in the referring component.</p>
<p>Clients of the I2C service would use it as follows:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">module</span> <span class="pre">I2CUserM</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">uses</span> <span class="pre">interface</span> <span class="pre">Resource</span> <span class="pre">as</span> <span class="pre">I2CResource;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">uses</span> <span class="pre">interface</span> <span class="pre">I2CPacket;</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span> <span class="pre">...</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">includes</span> <span class="pre">I2CPacketC;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">configuration</span> <span class="pre">I2CUserC</span> <span class="pre">{</span> <span class="pre">}</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">implementation</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">components</span> <span class="pre">I2CUserM,</span> <span class="pre">I2CPacketC;</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">I2CUserM.I2CResource</span> <span class="pre">-&gt;</span> <span class="pre">I2CPacketC.Resource[unique(I2C_RESOURCE)];</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">I2CUserM.I2CPacket</span> <span class="pre">-&gt;</span> <span class="pre">I2CPacket.I2CPacket[0x73];</span> <span class="pre">//</span> <span class="pre">using</span> <span class="pre">I2C</span> <span class="pre">device</span> <span class="pre">0x73</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span></tt></div>
</div>
<p>A final note: in some cases, resource reservation will correspond to
hardware resource reservation (e.g., for I2C). In other cases --- where
there is no hardware, for a bus which cannot be reserved, etc --- resource
reservation is purely a reservation of the software component itself.</p>
<div class="section" id="cross-component-reservation">
<h2><a name="cross-component-reservation">3.1 Cross-component reservation</a></h2>
<p>In some cases, it is desireable to share reservation of resources across
components. For example, on the TI MSP 430, the same pins can be used as
an I2C bus, a UART, or an SPI connection. Clearly, on this chip, a reservation
of the I2C bus implicitly reserves the corresponding UART and SPI. This can
be accomplished in the framework described above by:
1) using the same unique string for all three resources
2) wiring the three parameterised Resource interfaces to the same arbiter</p>
<p>This could be done as follows (the UART and SPI components are omitted, they
are similar to I2CC):</p>
<p>I2CC.nc (a low-level I2C component):</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">#define</span> <span class="pre">I2C_RESOURCE</span> <span class="pre">MSP_BUS_RESOURCE</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">configuration</span> <span class="pre">I2CC</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">interface</span> <span class="pre">Resource[uint8_t</span> <span class="pre">clientId];</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">interface</span> <span class="pre">I2C;</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">implementation</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">components</span> <span class="pre">MspBusC,</span> <span class="pre">I2CM;</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">Resource</span> <span class="pre">=</span> <span class="pre">MspBusC.Resource;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">I2C</span> <span class="pre">=</span> <span class="pre">I2CM.I2C;</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span></tt></div>
</div>
<p>MspBusC (the arbiter for the MSP bus):</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">#define</span> <span class="pre">MSP_BUS_RESOURCE</span> <span class="pre">&quot;MspBus.Resource&quot;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">configuration</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">interface</span> <span class="pre">Resource[uint8_t</span> <span class="pre">clientId];</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span> <span class="pre">...</span></tt></div>
</div>
</div>
</div>
<div class="section" id="default-arbiters">
<h1><a name="default-arbiters">4. Default arbiters</a></h1>
<p>Each service could provide its own implementation of the Resource
interface, but this would be a waste of programmer effort and would lead to
inconsistent resource sharing policies across services. Instead, TinyOS
includes a number of default resource arbiters, in the form of generic
components, which implement the Resource interface. All of these arbiters
also provide a ResourceUser interface which can be interrogated to find the
current set of resource allocation:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">interface</span> <span class="pre">ResourceUser</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">Check</span> <span class="pre">whether</span> <span class="pre">resource</span> <span class="pre">is</span> <span class="pre">allocated.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">&#64;returns</span> <span class="pre">TRUE</span> <span class="pre">if</span> <span class="pre">the</span> <span class="pre">resource</span> <span class="pre">is</span> <span class="pre">currently</span> <span class="pre">allocated,</span> <span class="pre">FALSE</span> <span class="pre">otherwise.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">command</span> <span class="pre">bool</span> <span class="pre">inUse();</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">/**</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">Return</span> <span class="pre">id</span> <span class="pre">of</span> <span class="pre">client</span> <span class="pre">currently</span> <span class="pre">using</span> <span class="pre">the</span> <span class="pre">resource.</span> <span class="pre">Meaningless</span> <span class="pre">if</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*</span> <span class="pre">inUse()</span> <span class="pre">returns</span> <span class="pre">FALSE.</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">*/</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">command</span> <span class="pre">uint8_t</span> <span class="pre">user();</span></tt></div>
</div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span></tt></div>
</div>
<p>ResourceUser can be used by the service implementation, e.g., to refuse
requests when it is not allocated. Or to allow implicit per-request
resource allocation in the style of TinyOS 1.x.</p>
<p>The RoundRobinArbiter provides round-robin arbitration:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">generic</span> <span class="pre">component</span> <span class="pre">RoundRobinArbiter</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">interface</span> <span class="pre">Resource[uin8_t</span> <span class="pre">id];</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">interface</span> <span class="pre">ResourceUser;</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span></tt></div>
</div>
<p>There is also a First-Come-First-Served (Fcfs) arbiter. RoundRobin
grants the resource based on a fixed order (ids), while Fcfs grants it
based on request order.</p>
</div>
<div class="section" id="request-queuing-and-resource-virtualisation">
<h1><a name="request-queuing-and-resource-virtualisation">5. Request queuing and resource virtualisation</a></h1>
<p>A service which is queued or provides virtualisation is implemented by
parameterising the service interface (in contrast, the resource reservation
approach parameterises the Resource interface). As with Resource, each
client obtains an id via unique(). The service must support one outstanding
request for each unique id; a second request (before completion of the
first) on the same instance of a parameterised interface returns EBUSY.</p>
<p>As an example, the Timer services looks as follows:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">configuration</span> <span class="pre">TimerMillicC</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">interface</span> <span class="pre">Timer&lt;TMilli&gt;[uint8_t</span> <span class="pre">id];</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span> <span class="pre">...</span></tt></div>
</div>
<p>and clients use it as follows:
| <tt class="docutils literal"><span class="pre">module</span> <span class="pre">TimerUserM</span> <span class="pre">{</span></tt>
|   <tt class="docutils literal"><span class="pre">uses</span> <span class="pre">interface</span> <span class="pre">Timer&lt;TMilli&gt;</span> <span class="pre">as</span> <span class="pre">MyTimer;</span></tt>
| <tt class="docutils literal"><span class="pre">}</span> <span class="pre">...</span></tt></p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">configuration</span> <span class="pre">TimerUserC</span> <span class="pre">{</span> <span class="pre">}</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">implementation</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">components</span> <span class="pre">TimerUserM,</span> <span class="pre">TimerC;</span></tt></div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal"><span class="pre">TimerUserM.MyTimer</span> <span class="pre">-&gt;</span> <span class="pre">TimerC.Timer[unique(TIMER_SERVICE)];</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span></tt></div>
</div>
<p>The difference between queuing of requests and virtualisation is only
in the internal implementation of a service, and is thus beyond the
scope of this document.</p>
<p>We also note that some queued/virtualised services may wish to also support
reservation, e.g., an A/D conveter which wants to support low-latency
requests.  Such components will use the same id for their service and
resource interfaces, e.g.:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">#define</span> <span class="pre">ADC_RESOURCE</span> <span class="pre">&quot;Adc.resource&quot;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">#define</span> <span class="pre">ADC_SERVICE</span> <span class="pre">ADC_RESOURCE</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">configuration</span> <span class="pre">ADCC</span> <span class="pre">{</span></tt></div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">interface</span> <span class="pre">ADC[uint8_t</span> <span class="pre">id];</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">interface</span> <span class="pre">Resource[uint8_t</span> <span class="pre">id];</span></tt></div>
</div>
<div class="line"><tt class="docutils literal"><span class="pre">}</span> <span class="pre">...</span></tt></div>
</div>
</div>
<div class="section" id="author-s-address">
<h1><a name="author-s-address">6. Author's Address</a></h1>
<div class="line-block">
<div class="line">David Gay</div>
<div class="line">2150 Shattuck Ave, Suite 1300</div>
<div class="line">Intel Research</div>
<div class="line">Berkeley, CA 94704</div>
<div class="line"><br /></div>
<div class="line">phone - +1 510 495 3055</div>
<div class="line">email - <a class="reference" href="mailto:david.e.gay&#64;intel.com">david.e.gay&#64;intel.com</a></div>
<div class="line"><br /></div>
<div class="line">David Culler</div>
<div class="line">627 Soda Hall</div>
<div class="line">UC Berkeley</div>
<div class="line">Berkeley, CA 94720</div>
<div class="line"><br /></div>
<div class="line">phone - +1 510 643 7572</div>
<div class="line">email - <a class="reference" href="mailto:culler&#64;cs.berkeley.edu">culler&#64;cs.berkeley.edu</a></div>
<div class="line"><br /></div>
<div class="line">Philip Levis</div>
<div class="line">358 Gates Hall</div>
<div class="line">Stanford University</div>
<div class="line">Stanford, CA 94305-9030</div>
<div class="line"><br /></div>
<div class="line">phone - +1 650 725 9046</div>
<div class="line">email - <a class="reference" href="mailto:pal&#64;cs.stanford.edu">pal&#64;cs.stanford.edu</a></div>
<div class="line"><br /></div>
<div class="line">Kevin Klues</div>
<div class="line">Sekr FT5</div>
<div class="line">Einsteinufer 25</div>
<div class="line">10587 Berlin</div>
<div class="line">GERMANY</div>
<div class="line"><br /></div>
<div class="line">phone - +49-30-314-23813</div>
<div class="line">email - <a class="reference" href="mailto:klues&#64;tkn.tu-berlin.de">klues&#64;tkn.tu-berlin.de</a></div>
</div>
</div>
</div>
</body>
</html>
